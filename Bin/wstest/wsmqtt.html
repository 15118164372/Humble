
<!DOCTYPE html>
<html lang="zh_CN">
<head>
    <meta charset="utf-8">
    <title> websockt mqtt test </title>
    <script src="./mqttws31.js" type="text/javascript"></script>
</head>
<body>
<div>
    <div>
        <div>
            <label>Host</label>
            <input id="urlInput" type="text" value="127.0.0.1">
            <label>Port</label>
            <input id="portInput" type="text" value="16200"/>
            <label>ClientID</label>
            <input id="clientIdInput" type="text" value="client123456"/>
        </div>

        <div>
            <label>Username</label>
            <input id="userInput" type="text"/>
            <label>Password</label>
            <input id="pwInput" type="text"/>
        </div>

        <div>
            <label>Keep Alive</label>
            <input id="keepAliveInput" type="number" style="width: 50px" value="60"/>

            <label>Clean Session</label>
            <input id="cleanSessionInput" type="checkbox" checked="checked"/>
        </div>
        <div>
            <label>Will</label>
            <input id="willInput" type="checkbox"/>
            <label>Will Retain</label>
            <input id="LWRInput" type="checkbox"/>
            <label>Will QoS</label>
            <select id="willQosInput">
                <option>0</option>
                <option>1</option>
                <option>2</option>
            </select>
        </div>
        <div>
            <label>Will Topic</label>
            <input id="willTopicInput" type="text"/>
            <label>Will Messsage</label>
            <textarea id="LWMInput"></textarea>
        </div>

        <div>
            <button id="connectButton" onclick="CONNECT()">Connect</button>
            <button id="disconnectButton" class="small button"
                    onclick="DISCONNECT()">Disconnect</button>
        </div>
    </div>
    <br/>
    <br/>
    <div>
        <div>
            <label>QoS</label>
            <select id="publishQoSInput">
                <option>0</option>
                <option>1</option>
                <option>2</option>
            </select>
            <label>Retain</label>
            <input id="publishRetain" type="checkbox">
        </div>
        <div>
            <label>Topic</label>
            <input id="publishTopic" type="text" value="testtopic/1">
            <label>Message</label>
            <textarea id="publishPayload"></textarea>
        </div>
        <div>
            <button id="publishButton" onclick="PUBLISH()">Publish</button>
        </div>
    </div>
    <br/>
    <br/>
    <div>
        <div>
            <label>Topic</label>
            <input id="subscribeTopic" type="text" value="testtopic/1">
            <label>QoS</label>
            <select id="subscribeQoSInput">
                <option>0</option>
                <option>1</option>
                <option>2</option>
            </select>
        </div>
        <div>
            <button id="subscribeButton" onclick="SUBSCRIBE()">Subscribe</button>
        </div>
    </div>
    <br/>
    <br/>
    <div>
        <div>
            <label>Topic</label>
            <input id="unsubscribeTopic" type="text" value="testtopic/1">
        </div>
        <div>
            <button id="unsubscribeButton" onclick="UNSUBSCRIBE()">UnSubscribe</button>
        </div>
    </div>
    <br/>
    <br/>
    <div>
        <label>Recv Message</label>
        <textarea id="recvPayload" style="width: 400px; height: 100px"></textarea>
    </div>
</div>

<script>
    var client;
    function CONNECT() {
        var host = document.getElementById("urlInput").value;
        var port = parseInt(document.getElementById("portInput").value);
        var clientId = document.getElementById("clientIdInput").value;
        var userName = document.getElementById("userInput").value;
        var psw = document.getElementById("pwInput").value;
        var keepAlive = parseInt(document.getElementById("keepAliveInput").value);
        var cleanSession = document.getElementById("cleanSessionInput").checked;
        var will = document.getElementById("willInput").checked;
        var willRetain = document.getElementById("LWRInput").checked;
        var willQos = document.getElementById("willQosInput").value;
        var willTopic = document.getElementById("willTopicInput").value;
        var willMsg = document.getElementById("LWMInput").value;

        console.log("--------------------CONNECT--------------------");
        console.log("host:", host, "port:", port);
        console.log("clientId:", clientId, "userName:", userName, "psw:", psw);
        console.log("keepAlive:", keepAlive, "cleanSession:", cleanSession);
        console.log("will:", will, "willRetain:", willRetain, "willQos:", willQos);
        console.log("willTopic:", willTopic, "willMsg:", willMsg);

        client = new Paho.MQTT.Client(host, port, clientId);
        // set callback handlers
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        //建立客户端实例
        var objWillMsg = {
            qos:willQos,
            retained:willRetain,
            destinationName:willTopic,
            stringPayload:willMsg,
        };
        var options = {
            timeout : 30,
            userName: userName,
            password: psw,
            //willMessage:objWillMsg,
            keepAliveInterval: keepAlive,
            cleanSession: cleanSession,
            useSSL:false,
            mqttVersion:4,
            onSuccess: onConnect
        };

		// connect the client
		client.connect(options);
    }
    function DISCONNECT() {
        console.log("--------------------DISCONNECT--------------------");
        client.disconnect();
    }
    function PUBLISH() {
        var QoS = parseInt(document.getElementById("publishQoSInput").value);
        var Retain = document.getElementById("publishRetain").checked;
        var Topic = document.getElementById("publishTopic").value;
        var Message = document.getElementById("publishPayload").value;

        console.log("--------------------PUBLISH--------------------");
        console.log("QoS:", QoS, "Retain:", Retain);
        console.log("Topic:", Topic, "Message:", Message);

        client.send(Topic, Message, QoS, Retain);
    }
    function SUBSCRIBE() {
        var Topic = document.getElementById("subscribeTopic").value;
        var QoS = parseInt(document.getElementById("subscribeQoSInput").value);

        console.log("--------------------SUBSCRIBE--------------------");
        console.log("Topic:", Topic, "QoS:", QoS);

        client.subscribe(Topic, {qos:QoS});
    }
    function UNSUBSCRIBE() {
        var Topic = document.getElementById("unsubscribeTopic").value;

        console.log("--------------------UNSUBSCRIBE--------------------");
        console.log("Topic:", Topic);

        client.unsubscribe(Topic);
    }

    // called when the client connects
    function onConnect() {
        var d = new Date();
        document.getElementById("recvPayload").value = "[" + d.toLocaleString() + "]连接成功";
    }
    // called when the client loses its connection
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            var d = new Date();
			document.getElementById("recvPayload").value = "[" + d.toLocaleString() + "]连接断开";
        }
    }
    // called when a message arrives
    function onMessageArrived(message) {
        var d = new Date();
        document.getElementById("recvPayload").value = "[" + d.toLocaleString() + "]" + message.payloadString;
    }
</script>
</body>
</html>

